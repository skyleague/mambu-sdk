/**
 * Generated by @skyleague/therefore@v1.0.0-local
 * Do not manually touch this
 */
/* eslint-disable */
import got from 'got'
import type { CancelableRequest, Got, Options, Response } from 'got'
import type { ValidateFunction, ErrorObject } from 'ajv'
import type { IncomingHttpHeaders } from 'http'
import {
    DisbursementLoanTransactionInput,
    ErrorResponse,
    FeeLoanTransactionInput,
    GetAllResponse,
    GetTransactionsForAllVersionsResponse,
    LoanTransaction,
    LoanTransactionAdjustmentDetails,
    LoanTransactionSearchCriteria,
    LockLoanAccountInput,
    LockLoanTransactionsWrapper,
    PaymentMadeTransactionInput,
    RedrawRepaymentTransactionInputDTO,
    RepaymentLoanTransactionInput,
    SearchResponse,
    UnlockLoanAccountInput,
    WithdrawalRedrawTransactionInput,
} from './rest.type.js'

/**
 * loans/transactions
 */
export class MambuLoanTransactions {
    public client: Got

    public auth: {
        basic?: [username: string, password: string] | (() => Promise<[username: string, password: string]>)
        apiKey?: string | (() => Promise<string>)
    }

    public availableAuth: Set<string>
    public defaultAuth: string[][] | string[] | undefined

    public constructor({
        prefixUrl,
        options,
        auth = {},
        defaultAuth,
    }: {
        prefixUrl: string | 'http://localhost:8889/api' | 'https://localhost:8889/api'
        options?: Options
        auth: {
            basic?: [username: string, password: string] | (() => Promise<[username: string, password: string]>)
            apiKey?: string | (() => Promise<string>)
        }
        defaultAuth?: string[][] | string[]
    }) {
        this.client = got.extend(...[{ prefixUrl, throwHttpErrors: false }, options].filter((o): o is Options => o !== undefined))
        this.auth = auth
        this.availableAuth = new Set(Object.keys(auth))
        this.defaultAuth = defaultAuth
    }

    /**
     * Client Directed Query. Allows you to search loan transactions for loan accounts by various criteria
     */
    public async search({
        body,
        query,
        auth = [['apiKey'], ['basic']],
    }: {
        body: LoanTransactionSearchCriteria
        query?: { offset?: string; limit?: string; paginationDetails?: string; detailsLevel?: string }
        auth?: string[][] | string[]
    }) {
        this.validateRequestBody(LoanTransactionSearchCriteria, body)

        return this.awaitResponse(
            this.buildClient(auth).post(`loans/transactions:search`, {
                json: body,
                searchParams: query ?? {},
                headers: { Accept: 'application/vnd.mambu.v2+json' },
                responseType: 'json',
            }),
            {
                200: SearchResponse,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Lock a loan account's income sources (e.g. interest, fees, penalties)
     */
    public async applyLock({
        body,
        path,
        headers,
        auth = [['apiKey'], ['basic']],
    }: {
        body: LockLoanAccountInput
        path: { loanAccountId: string }
        headers?: { ['Idempotency-Key']?: string }
        auth?: string[][] | string[]
    }) {
        this.validateRequestBody(LockLoanAccountInput, body)

        return this.awaitResponse(
            this.buildClient(auth).post(`loans/${path.loanAccountId}/lock-transactions`, {
                json: body,
                headers: { Accept: 'application/vnd.mambu.v2+json', ...headers },
                responseType: 'json',
            }),
            {
                102: { is: (_x: unknown): _x is unknown => true },
                201: LockLoanTransactionsWrapper,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Unlock a loan account's income sources (e.g. interest, fees, penalties)
     */
    public async applyUnlock({
        body,
        path,
        headers,
        auth = [['apiKey'], ['basic']],
    }: {
        body: UnlockLoanAccountInput
        path: { loanAccountId: string }
        headers?: { ['Idempotency-Key']?: string }
        auth?: string[][] | string[]
    }) {
        this.validateRequestBody(UnlockLoanAccountInput, body)

        return this.awaitResponse(
            this.buildClient(auth).post(`loans/${path.loanAccountId}/unlock-transactions`, {
                json: body,
                headers: { Accept: 'application/vnd.mambu.v2+json', ...headers },
                responseType: 'json',
            }),
            {
                102: { is: (_x: unknown): _x is unknown => true },
                201: LockLoanTransactionsWrapper,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Make a repayment transaction on a loan
     */
    public async makeRepayment({
        body,
        path,
        headers,
        auth = [['apiKey'], ['basic']],
    }: {
        body: RepaymentLoanTransactionInput
        path: { loanAccountId: string }
        headers?: { ['Idempotency-Key']?: string }
        auth?: string[][] | string[]
    }) {
        this.validateRequestBody(RepaymentLoanTransactionInput, body)

        return this.awaitResponse(
            this.buildClient(auth).post(`loans/${path.loanAccountId}/repayment-transactions`, {
                json: body,
                headers: { Accept: 'application/vnd.mambu.v2+json', ...headers },
                responseType: 'json',
            }),
            {
                102: { is: (_x: unknown): _x is unknown => true },
                201: LoanTransaction,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Adjustment of loan transactions. Note that adjusting fees is still in beta and known issues will be fixed start of Q2/2019
     */
    public async adjust({
        body,
        path,
        headers,
        auth = [['apiKey'], ['basic']],
    }: {
        body: LoanTransactionAdjustmentDetails
        path: { loanTransactionId: string }
        headers?: { ['Idempotency-Key']?: string }
        auth?: string[][] | string[]
    }) {
        this.validateRequestBody(LoanTransactionAdjustmentDetails, body)

        return this.awaitResponse(
            this.buildClient(auth).post(`loans/transactions/${path.loanTransactionId}:adjust`, {
                json: body,
                headers: { Accept: 'application/vnd.mambu.v2+json', ...headers },
                responseType: 'json',
            }),
            {
                102: { is: (_x: unknown): _x is unknown => true },
                200: LoanTransaction,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Make a disbursement on a loan
     */
    public async makeDisbursement({
        body,
        path,
        headers,
        auth = [['apiKey'], ['basic']],
    }: {
        body: DisbursementLoanTransactionInput
        path: { loanAccountId: string }
        headers?: { ['Idempotency-Key']?: string }
        auth?: string[][] | string[]
    }) {
        this.validateRequestBody(DisbursementLoanTransactionInput, body)

        return this.awaitResponse(
            this.buildClient(auth).post(`loans/${path.loanAccountId}/disbursement-transactions`, {
                json: body,
                headers: { Accept: 'application/vnd.mambu.v2+json', ...headers },
                responseType: 'json',
            }),
            {
                102: { is: (_x: unknown): _x is unknown => true },
                201: LoanTransaction,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Allows retrieval of a single loan transaction via id or encoded key
     */
    public async getById({
        path,
        query,
        auth = [['apiKey'], ['basic']],
    }: {
        path: { loanTransactionId: string }
        query?: { detailsLevel?: string }
        auth?: string[][] | string[]
    }) {
        return this.awaitResponse(
            this.buildClient(auth).get(`loans/transactions/${path.loanTransactionId}`, {
                searchParams: query ?? {},
                headers: { Accept: 'application/vnd.mambu.v2+json' },
                responseType: 'json',
            }),
            {
                200: LoanTransaction,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Allows retrieval of all transactions for all versions of loan account via id or encoded key
     */
    public async getTransactionsForAllVersions({
        path,
        query,
        auth = [['apiKey'], ['basic']],
    }: {
        path: { loanAccountId: string }
        query?: { offset?: string; limit?: string; paginationDetails?: string; detailsLevel?: string }
        auth?: string[][] | string[]
    }) {
        return this.awaitResponse(
            this.buildClient(auth).get(`loans/${path.loanAccountId}/transactions:versions`, {
                searchParams: query ?? {},
                headers: { Accept: 'application/vnd.mambu.v2+json' },
                responseType: 'json',
            }),
            {
                200: GetTransactionsForAllVersionsResponse,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Make a withdrawal from redraw balance
     */
    public async makeWithdrawal({
        body,
        path,
        headers,
        auth = [['apiKey'], ['basic']],
    }: {
        body: WithdrawalRedrawTransactionInput
        path: { loanAccountId: string }
        headers?: { ['Idempotency-Key']?: string }
        auth?: string[][] | string[]
    }) {
        this.validateRequestBody(WithdrawalRedrawTransactionInput, body)

        return this.awaitResponse(
            this.buildClient(auth).post(`loans/${path.loanAccountId}/withdrawal-transactions`, {
                json: body,
                headers: { Accept: 'application/vnd.mambu.v2+json', ...headers },
                responseType: 'json',
            }),
            {
                102: { is: (_x: unknown): _x is unknown => true },
                201: LoanTransaction,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Make a payment in redraw balance for a loan
     */
    public async applyPaymentMade({
        body,
        path,
        headers,
        auth = [['apiKey'], ['basic']],
    }: {
        body: PaymentMadeTransactionInput
        path: { loanAccountId: string }
        headers?: { ['Idempotency-Key']?: string }
        auth?: string[][] | string[]
    }) {
        this.validateRequestBody(PaymentMadeTransactionInput, body)

        return this.awaitResponse(
            this.buildClient(auth).post(`loans/${path.loanAccountId}/payment-made-transactions`, {
                json: body,
                headers: { Accept: 'application/vnd.mambu.v2+json', ...headers },
                responseType: 'json',
            }),
            {
                102: { is: (_x: unknown): _x is unknown => true },
                201: LoanTransaction,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Make a redraw repayment transaction on a loan
     */
    public async makeRedrawRepayment({
        body,
        path,
        headers,
        auth = [['apiKey'], ['basic']],
    }: {
        body: RedrawRepaymentTransactionInputDTO
        path: { loanAccountId: string }
        headers?: { ['Idempotency-Key']?: string }
        auth?: string[][] | string[]
    }) {
        this.validateRequestBody(RedrawRepaymentTransactionInputDTO, body)

        return this.awaitResponse(
            this.buildClient(auth).post(`loans/${path.loanAccountId}/redraw-repayment-transactions`, {
                json: body,
                headers: { Accept: 'application/vnd.mambu.v2+json', ...headers },
                responseType: 'json',
            }),
            {
                102: { is: (_x: unknown): _x is unknown => true },
                201: LoanTransaction,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Allows retrieval of all transactions for a loan account via id or encoded key
     */
    public async getAll({
        path,
        query,
        auth = [['apiKey'], ['basic']],
    }: {
        path: { loanAccountId: string }
        query?: { offset?: string; limit?: string; paginationDetails?: string; detailsLevel?: string }
        auth?: string[][] | string[]
    }) {
        return this.awaitResponse(
            this.buildClient(auth).get(`loans/${path.loanAccountId}/transactions`, {
                searchParams: query ?? {},
                headers: { Accept: 'application/vnd.mambu.v2+json' },
                responseType: 'json',
            }),
            {
                200: GetAllResponse,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    /**
     * Apply a fee on a loan account
     */
    public async applyFee({
        body,
        path,
        headers,
        auth = [['apiKey'], ['basic']],
    }: {
        body: FeeLoanTransactionInput
        path: { loanAccountId: string }
        headers?: { ['Idempotency-Key']?: string }
        auth?: string[][] | string[]
    }) {
        this.validateRequestBody(FeeLoanTransactionInput, body)

        return this.awaitResponse(
            this.buildClient(auth).post(`loans/${path.loanAccountId}/fee-transactions`, {
                json: body,
                headers: { Accept: 'application/vnd.mambu.v2+json', ...headers },
                responseType: 'json',
            }),
            {
                102: { is: (_x: unknown): _x is unknown => true },
                201: LoanTransaction,
                400: ErrorResponse,
                401: ErrorResponse,
                403: ErrorResponse,
                404: ErrorResponse,
            }
        )
    }

    public validateRequestBody<T>(schema: { is: (o: unknown) => o is T; assert: (o: unknown) => void }, body: T) {
        schema.assert(body)
        return body
    }

    public async awaitResponse<
        T,
        S extends Record<PropertyKey, undefined | { is: (o: unknown) => o is T; validate?: ValidateFunction<T> }>
    >(response: CancelableRequest<Response<unknown>>, schemas: S) {
        type FilterStartingWith<S extends PropertyKey, T extends string> = S extends number | string
            ? `${S}` extends `${T}${infer _X}`
                ? S
                : never
            : never
        type InferSchemaType<T> = T extends { is: (o: unknown) => o is infer S } ? S : never
        const result = await response
        const validator = schemas[result.statusCode] ?? schemas.default
        if (validator?.is(result.body) === false || result.statusCode < 200 || result.statusCode >= 300) {
            return {
                statusCode: result.statusCode,
                headers: result.headers,
                left: result.body,
                validationErrors: validator?.validate?.errors ?? undefined,
            } as {
                statusCode: number
                headers: IncomingHttpHeaders
                left: InferSchemaType<S[keyof S]>
                validationErrors?: ErrorObject[]
            }
        }
        return { statusCode: result.statusCode, headers: result.headers, right: result.body } as {
            statusCode: number
            headers: IncomingHttpHeaders
            right: InferSchemaType<S[keyof Pick<S, FilterStartingWith<keyof S, '2' | 'default'>>]>
        }
    }

    protected buildBasicClient(client: Got) {
        return client.extend({
            hooks: {
                beforeRequest: [
                    async (options) => {
                        const basic = this.auth.basic
                        if (basic !== undefined) {
                            const [username, password] = typeof basic === 'function' ? await basic() : basic
                            options.username = username
                            options.password = password
                        }
                    },
                ],
            },
        })
    }

    protected buildApiKeyClient(client: Got) {
        return client.extend({
            hooks: {
                beforeRequest: [
                    async (options) => {
                        const apiKey = this.auth.apiKey
                        const key = typeof apiKey === 'function' ? await apiKey() : apiKey
                        options.headers['apiKey'] = key
                    },
                ],
            },
        })
    }

    protected buildClient(auths: string[][] | string[] | undefined = this.defaultAuth, client: Got = this.client): Got {
        const auth = (auths ?? [...this.availableAuth])
            .map((auth) => (Array.isArray(auth) ? auth : [auth]))
            .filter((auth) => auth.every((a) => this.availableAuth.has(a)))
        for (const chosen of auth[0] ?? []) {
            if (chosen === 'basic') {
                client = this.buildBasicClient(client)
            } else if (chosen === 'apiKey') {
                client = this.buildApiKeyClient(client)
            }
        }
        return client
    }
}
